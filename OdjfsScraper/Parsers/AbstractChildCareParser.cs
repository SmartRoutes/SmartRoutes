using System;
using System.Collections.Generic;
using System.Globalization;
using System.IO;
using System.Linq;
using System.Net;
using System.Text.RegularExpressions;
using CsQuery;
using CsQuery.Implementation;
using Model.Odjfs;
using NLog;
using OdjfsScraper.Support;
using Scraper;

namespace OdjfsScraper.Parsers
{
    public abstract class AbstractChildCareParser<T> : IChildCareParser<T> where T : ChildCare
    {
        private static readonly Logger Logger = LogManager.GetCurrentClassLogger();

        public void Parse(T childCare, byte[] bytes)
        {
            // get the hash and no-op if the hash has not changed
            string currentHash = bytes.GetSha256Hash();
            if (currentHash == childCare.LastHash)
            {
                return;
            }

            // record this execution
            childCare.LastHash = currentHash;
            childCare.LastParsed = DateTime.Now; // TODO: UTC or local time

            // parse the HTML
            CQ document = CQ.Create(new MemoryStream(bytes));

            // get the details
            KeyValuePair<string, string>[] keyValuePairs = GetDetailKeyValuePairs(document)
                .Where(p => p.Key != null)
                .ToArray();

            // make sure the keys are unique
            string[] keys = keyValuePairs.Select(p => p.Key).ToArray();
            string[] uniqueKeys = keys.Distinct().ToArray();
            if (keys.Length != uniqueKeys.Length)
            {
                var exception = new ParserException("All keys in the first details table must be unique.");
                Logger.ErrorException(string.Format("Type: '{0}', OriginalKeys: {1}", typeof (T).Name, string.Join(", ", keys)), exception);
                throw exception;
            }

            // create the dictionary
            IDictionary<string, string> details = keyValuePairs.ToDictionary(t => t.Key, t => t.Value);

            // generate the concrete object using the child implementation
            PopulateFields(childCare, details);
        }

        protected abstract IEnumerable<KeyValuePair<string, string>> GetDetailKeyValuePairs(CQ document);
        protected abstract void PopulateFields(T childCare, IDictionary<string, string> details);

        #region Helpers

        protected static void ReplaceImagesWithText(IDomElement parent, IDictionary<string, string> replacements)
        {
            // replace all of the images with text
            IDomElement[] images = parent
                .GetDescendentElements()
                .Where(e => e.NodeName == "IMG")
                .ToArray();
            foreach (IDomElement image in images)
            {
                string text;
                if (!replacements.TryGetValue(image.GetAttribute("src"), out text))
                {
                    text = "unknown";
                }
                image.ParentNode.InsertAfter(new DomText(text), image);
                image.Remove();
            }
        }

        protected static DateTime ParseDate(string date)
        {
            return DateTime.ParseExact(date, "MM/dd/yyyy", CultureInfo.InvariantCulture);
        }

        protected static string GetDetailString(IDictionary<string, string> details, params string[] keys)
        {
            // try all of the provided keys to get the value
            foreach (string key in keys)
            {
                string value;
                if (details.TryGetValue(key, out value))
                {
                    return value;
                }
            }

            var exception = new ParserException("An expected key was not found in the child care details.");
            Logger.ErrorException(string.Format("AllKeys: '{0}', KeysTried: '{1}'", string.Join(", ", details.Keys), string.Join(", ", keys)), exception);
            throw exception;
        }

        #endregion
    }
}